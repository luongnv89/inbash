#!/usr/bin/env bash

###############################################################################
# inbash :: show_ip
# ---------------------------------------------------------------------------
# Description : Renders a login banner (\e/etc/issue\e) that highlights the
#               system's IPv4 address for SSH access. Intended to be invoked
#               from Debian/Ubuntu network hook directories.
# Usage       : ./show_ip [--issue-file <path>] [--dry-run] [--columns <n>]
# Example     : ./show_ip --issue-file /tmp/issue --dry-run
# Requirements: root privileges (unless --dry-run), ip/ifconfig utilities.
###############################################################################

set -euo pipefail

readonly SCRIPT_NAME="$(basename "$0")"
readonly DEFAULT_ISSUE_FILE="/etc/issue"
readonly DEFAULT_COLUMNS=80
readonly LOG_TAG="show_ip"

readonly COLOR_RESET=$'\033[0m'
readonly COLOR_HIGHLIGHT=$'\033[1;33m'
readonly COLOR_BLINK=$'\033[5;33m'

ISSUE_FILE="$DEFAULT_ISSUE_FILE"
DRY_RUN=0
COLUMNS_OVERRIDE=""

log_info() {
  local message="$*"
  logger -t "$LOG_TAG" "$message" 2>/dev/null || true
  printf '[INFO] %s\n' "$message" >&2
}

log_warn() {
  local message="$*"
  logger -t "$LOG_TAG" "WARN: $message" 2>/dev/null || true
  printf '[WARN] %s\n' "$message" >&2
}

log_error() {
  local message="$*"
  logger -t "$LOG_TAG" "ERROR: $message" 2>/dev/null || true
  printf '[ERROR] %s\n' "$message" >&2
}

usage() {
  cat <<EOF
Usage: $SCRIPT_NAME [options]

Options:
  --issue-file PATH  Write banner to PATH instead of $DEFAULT_ISSUE_FILE.
  --columns N        Override width when centering text (default: auto/80).
  --dry-run          Output banner to stdout without touching the filesystem.
  -h, --help         Show this help message.

Designed to run automatically from /etc/network/if-up.d/ and
/etc/network/if-post-down.d/ to refresh the login banner with the
current IP address.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --issue-file)
      ISSUE_FILE="$2"
      shift 2
      ;;
    --columns)
      COLUMNS_OVERRIDE="$2"
      shift 2
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      log_error "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

if [[ $DRY_RUN -ne 1 && ${EUID:-0} -ne 0 ]]; then
  log_error "Root privileges are required to update $ISSUE_FILE."
  exit 1
fi

detect_columns() {
  local width="${COLUMNS_OVERRIDE}" || true
  if [[ -z "$width" ]]; then
    if command -v tput >/dev/null 2>&1; then
      width="$(tput cols 2>/dev/null || true)"
    fi
  fi
  if [[ -z "$width" ]]; then
    width="$DEFAULT_COLUMNS"
  fi
  if ! [[ "$width" =~ ^[0-9]+$ ]] || (( width < 40 )); then
    width="$DEFAULT_COLUMNS"
  fi
  printf '%s' "$width"
}

readonly COLUMNS_TARGET="$(detect_columns)"

center_line() {
  local text="$1"
  local width="$COLUMNS_TARGET"
  local length="${#text}"
  local padding=$(( (width + length) / 2 ))
  printf '%*s\n' "$padding" "$text"
}

write_center_to_file() {
  local text="$1"
  center_line "$text" >>"$ISSUE_TEMP_FILE"
}

write_blank_lines() {
  local count="$1"
  local i
  for (( i = 0; i < count; i++ )); do
    printf '\n' >>"$ISSUE_TEMP_FILE"
  done
}

write_color() {
  local color_sequence="$1"
  printf '%b' "$color_sequence" >>"$ISSUE_TEMP_FILE"
}

get_ipv4_lines() {
  if command -v ip >/dev/null 2>&1; then
    ip -o -4 addr show scope global | awk '{gsub(/\/.*/, "", $4); printf "%s: %s\n", $2, $4}'
  elif command -v /sbin/ip >/dev/null 2>&1; then
    /sbin/ip -o -4 addr show scope global | awk '{gsub(/\/.*/, "", $4); printf "%s: %s\n", $2, $4}'
  elif command -v ifconfig >/dev/null 2>&1; then
    ifconfig | awk '/inet / && $2 != "127.0.0.1" { print $1 ": " $2 }'
  elif command -v /sbin/ifconfig >/dev/null 2>&1; then
    /sbin/ifconfig | awk '/inet / && $2 != "127.0.0.1" { print $1 ": " $2 }'
  else
    echo "No IP command available"
  fi
}

render_banner() {
  local issue_file="$1"
  printf '\e[H\e[2J\n' >"$issue_file"
  write_center_to_file "Welcome to Ubuntu Server"
  write_blank_lines 5
  write_color "$COLOR_HIGHLIGHT"
  write_center_to_file "Do what you love and love what you are doing"
  write_center_to_file "             - You only live once - "
  write_color "$COLOR_RESET"
  write_blank_lines 3
  write_center_to_file "Access to the server via ssh command:"
  write_blank_lines 2
  write_color "$COLOR_BLINK"

  local ip_lines
  ip_lines="$(get_ipv4_lines)"
  if [[ -n "$ip_lines" ]]; then
    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      write_center_to_file "$line"
    done <<<"$ip_lines"
  else
    write_center_to_file "No active network interface detected"
  fi

  write_color "$COLOR_RESET"
  write_blank_lines 3
  write_center_to_file "Log in rescue to access the management utility"
}

ISSUE_TEMP_FILE="$(mktemp -t show-issue-XXXXXX)"
trap 'rm -f "$ISSUE_TEMP_FILE"' EXIT

render_banner "$ISSUE_TEMP_FILE"

if [[ $DRY_RUN -eq 1 ]]; then
  cat "$ISSUE_TEMP_FILE"
  log_info "Rendered banner in dry-run mode. No changes applied."
else
  install -m 0644 "$ISSUE_TEMP_FILE" "$ISSUE_FILE"
  log_info "Updated $ISSUE_FILE with current network information (width: $COLUMNS_TARGET)."
fi